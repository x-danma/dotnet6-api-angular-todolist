name: .NET API

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.x
    - name: Restore dependencies Web
      run: dotnet restore ./TodoWeb/TodoWeb.csproj
    - name: Build Web
      run: dotnet build ./TodoWeb/TodoWeb.csproj --no-restore
    - name: Test Web
      run: dotnet test ./TodoWeb/TodoWeb.csproj --no-build --verbosity normal
    - name: Azure Login
      uses: Azure/login@v1.4.0
      with:
        # Paste output of `az ad sp create-for-rbac` as value of secret variable: AZURE_CREDENTIALS
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        # TenantId of the Azure Service principal created.
        tenant-id: ${{ secrets.AZURE_MPN_TENANTID }}
        # Azure subscriptionId
        subscription-id: ${{ secrets.AZURE_MPN_SUBSCRIPTIONID }}
    - name: Azure WebApp Api Deploy
      uses: Azure/webapps-deploy@v2
      with:
        # Name of the Azure Web App
        app-name: dotnet6-api-angular-todolist-api
        # Enter the start up command. For ex. dotnet run or dotnet run
        startup-command: dotnet run
    
